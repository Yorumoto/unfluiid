from components.looper import Looper
from components.animator import Animator
from components.window import Window, WindowType

import common.context

from gi.repository import Gtk
from enum import Enum

class ItemType(Enum):
    Shutdown = 1
    Restart = 2
    Suspend = 3
    Logout = 4

class Item:
    _item_icons = {
        ItemType.Shutdown: "",
        ItemType.Restart: "",
        ItemType.Suspend: "",
        ItemType.Logout: "",
    }

    _small_size = (250, 300)

    def __init__(self, item_type, delay_time=0):
        self.item_type = item_type

        self.x = 0
        self.y = 0

        self.width = self._small_size[0]
        self.height = self._small_size[1]

        self._st = 0 # select time
        self._at = 0 # appearance time
        self._att = delay_time # appearance delay time

    def update(self, index, width, height, dt, selected):
        if self._att > 0:
            self._att -= dt
        else:
            self._at = min(self._at + dt, 1)

        center_x = (width * 0.5) - (self.height * 0.5)
        center_y = (height * 0.5) - (self.height * 0.5)
        

        self.x = align_x
        self.y = align_y

    def draw(self, ctx):
        ctx.set_source_rgba(0.3, 0.3, 0.3, 1)
        common.context.rounded_rectangle(ctx, self.x, self.y, self.width, self.height, 10)
        ctx.fill()

class Main(Looper):
    def __init__(self):
        super().__init__()

        self.items = [Item(x) for i, x in enumerate([ItemType.Shutdown, ItemType.Restart, ItemType.Suspend, ItemType.Logout])]

        self.window = Window(WindowType.FullScreen)

        self.main_animator = Animator(self.window)
        self.main_animator.main_draw_callback = self.draw
        self.window.connect_animated_overlay(self.main_animator)

        self.window.connect('key_press_event', self.on_key_press)
        self.window.create_window()
        self.window.grab()

        self.loop_init()

    def on_key_press(self, _, event):
        keycode = event.hardware_keycode
        string = event.string

        if keycode == 9:
            Gtk.main_quit() # instead of exiting abruptly, how about i make a gradual exiting animation
            return True

        return True

    def draw(self, ctx, width, height):
        ctx.translate(width * 0.5, height * 0.5)

        for item in self.items:
            item.draw(ctx)

    def update(self, dt):
        size = self.window.get_size()

        for index, item in enumerate(self.items):
            item.update(index, *size, dt, False)

        self.main_animator.draw()

        
